<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flarefix Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #messages { scroll-behavior: smooth; }
    .typing span {
      display:inline-block; width:6px; height:6px; margin:0 2px;
      border-radius:9999px; opacity:.3; animation: blink 1.2s infinite;
    }
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes blink { 0%,100%{opacity:.2} 50%{opacity:1} }
    #processing { display: none; text-align: center; margin-bottom: 0.5rem; color: #000000; font-weight: 500; }
    textarea { resize: none; overflow-y: hidden; }
  </style>
</head>
<script>
  const drawer = document.getElementById("drawer");
  const drawerBtn = document.getElementById("drawerBtn");
  let drawerOpen = false;

  drawerBtn.addEventListener("click", () => {
    drawerOpen = !drawerOpen;
    drawer.style.transform = drawerOpen ? "translateX(0)" : "translateX(-100%)";
  });
</script>
<body class="h-full bg-gray-50 text-gray-900">
  <div class="flex flex-col h-screen">
    <!-- Header -->
    <header class="px-4 py-3 border-b bg-white sticky top-0 z-10">
      <div class="max-w-5xl mx-auto flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-black text-gray-200 grid place-items-center font-bold">F</div>
        <h1 class="text-lg font-semibold">Flarefix</h1>
      </div>
    </header>

    <!-- Chat Messages -->
    <main id="messages" class="flex-1 overflow-y-auto px-3 py-3 h-[calc(100vh-120px)]">
      <div id="thread" class="max-w-3xl mx-auto space-y-4"></div>
    </main>

    <!-- Footer -->
    <footer class="px-3 pb-6">
      <div class="max-w-3xl mx-auto">
        <div id="processing" class="typing text-center mb-2">Flarefix is typing <span></span><span></span><span></span></div>
        
        <!-- Input container (centered initially) -->
        <div id="input-container" class="flex justify-center h-[80vh] items-center transition-all duration-500">
          <div class="w-full sm:w-[90%] md:w-[80%] lg:w-[70%] rounded-2xl border bg-white shadow-sm flex items-end gap-2 px-2">
            <textarea id="input" rows="1" placeholder="Message..."
              class="flex-1 p-3 outline-none max-h-40 text-sm sm:text-base"></textarea>
            <button id="send" 
              class="m-2 px-4 py-2 rounded-xl bg-black hover:bg-gray-800 text-white text-sm sm:text-base">
              Send
            </button>
            <button id="clear" 
              class="m-2 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400 text-black text-sm sm:text-base">
              Clear
            </button>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const API_URL = "https://chatbot-backend-hrvb.onrender.com/chat";
    const sessionId = crypto.randomUUID();

    const threadEl = document.getElementById('thread');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');
    const messagesView = document.getElementById('messages');
    const processingEl = document.getElementById('processing');
    const inputContainer = document.getElementById('input-container');

    let messages = [];
    let firstMessageSent = false;

    function renderMarkdown(text) {
      return text
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/\*(.*?)\*/g, "<em>$1</em>")
        .replace(/`([^`]+)`/g, "<code>$1</code>")
        .replace(/```([^`]+)```/gs, "<pre><code>$1</code></pre>")
        .replace(/\n/g, "<br>");
    }

    function render() {
      threadEl.innerHTML = '';
      messages.forEach(m => {
        const isUser = m.role === 'user';
        const div = document.createElement('div');
        div.className = `flex items-start gap-2 ${isUser ? 'justify-end' : ''}`;

        if (isUser) {
          div.innerHTML = `
            <div class="max-w-[80%] rounded-2xl px-3 py-2 shadow border text-sm bg-black text-white">
              <div class="message-content">${renderMarkdown(m.content)}</div>
            </div>`;
        } else {
          div.innerHTML = `
            <div class="w-7 h-7 rounded-full bg-black text-gray-200 flex items-center justify-center text-xs font-bold">F</div>
            <div class="max-w-[80%] rounded-2xl px-3 py-2 shadow border text-sm bg-white border-gray-200">
              <div class="message-content">${renderMarkdown(m.content)}</div>
            </div>`;
        }

        threadEl.appendChild(div);
      });
      messagesView.scrollTop = messagesView.scrollHeight;
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;
      inputEl.value = '';
      sendBtn.disabled = true;

      // After first send, move input box to bottom
      if (!firstMessageSent) {
        firstMessageSent = true;
        inputContainer.classList.remove("h-[80vh]", "items-center");
        inputContainer.classList.add("sticky", "bottom-0", "pb-4");
      }

      messages.push({ role: 'user', content: text });
      render();
      processingEl.style.display = 'block';

      try {
        const payload = { message: text, user_id: sessionId };
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        let reply = data.reply || 'No response';

        messages.push({ role: 'assistant', content: "" });
        render();

        let current = "";
        for (let i = 0; i < reply.length; i++) {
          current += reply[i];
          messages[messages.length - 1].content = current;
          render();
          await new Promise(r => setTimeout(r, 8));
        }

      } catch (e) {
        messages.push({ role: 'assistant', content: 'Error: ' + e.message });
        render();
      }

      processingEl.style.display = 'none';
      sendBtn.disabled = false;
      inputEl.focus();
    }

    inputEl.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { 
        e.preventDefault(); sendMessage(); 
      }
    });
    sendBtn.addEventListener('click', sendMessage);

    // Auto-expand textarea
    inputEl.addEventListener("input", () => {
      inputEl.style.height = "auto";
      inputEl.style.height = inputEl.scrollHeight + "px";
    });

    // Clear chat button
    clearBtn.addEventListener('click', () => {
      messages = [];
      render();
      firstMessageSent = false;
      inputContainer.classList.add("h-[80vh]", "items-center");
      inputContainer.classList.remove("sticky", "bottom-0", "pb-4");
    });
  </script>
</body>
<!-- Drawer + Button -->
<button id="drawerBtn" class="fixed top-4 left-4 z-50 bg-black text-white px-3 py-2 rounded-lg shadow">
  ‚ò∞
</button>

<div id="drawer"
  class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl transform -translate-x-full transition-transform duration-300 z-40">

  <div class="p-4 border-b">
    <h2 class="text-lg font-semibold">Flarefix Menu</h2>
  </div>

  <ul class="p-4 space-y-4 text-gray-700 text-base">
    <li><a href="home.html" class="hover:text-black">üè† New Chat</a></li>
    <li><a href="secret-chat.html" class="hover:text-black">üîí Secret Chat</a></li>
    <li><button onclick="alert('Settings coming soon')" class="w-full text-left hover:text-black">‚öôÔ∏è Settings</button></li>
    <li><button onclick="alert('Flarefix - Simple & Fast Chat')" class="w-full text-left hover:text-black">‚ÑπÔ∏è About</button></li>
  </ul>
</div>
</html>
