<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flarefix — Secret Room</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>html,body{height:100%} #thread { scroll-behavior: smooth; }</style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900 flex flex-col">

  <!-- Header -->
  <header class="px-4 py-3 border-b bg-white sticky top-0 z-10 flex items-center gap-3">
    <button onclick="window.location.href='home.html'" class="text-sm px-3 py-1 rounded bg-gray-200">← Back</button>
    <h1 class="text-lg font-semibold">Secret Room</h1>
    <div id="roomHint" class="ml-4 text-sm text-gray-600"></div>
  </header>

  <!-- Messages -->
  <main class="flex-1 overflow-y-auto px-3 py-4">
    <div id="thread" class="max-w-3xl mx-auto space-y-3"></div>
  </main>

  <!-- Input -->
  <footer class="p-3 bg-white border-t">
    <div class="max-w-3xl mx-auto flex gap-2 items-end">
      <input id="name" placeholder="Your name (optional)" class="w-40 border rounded-xl px-3 py-2 outline-none" />
      <textarea id="msg" rows="1" placeholder="Type a private message..." class="flex-1 border rounded-xl px-3 py-2 resize-none outline-none"></textarea>
      <button id="send" class="px-4 py-2 bg-black text-white rounded-xl">Send</button>
    </div>
  </footer>

<script>
/**
 * Flarefix Secret Room (Option A — simple 1:1 chat)
 * - Replace SUPABASE_URL and SUPABASE_ANON_KEY with your project's values
 * - Use rooms via path or query param:
 *    /secret-chat.html?room=abc  OR  /room/abc  (see room detection below)
 * - This client uses anon key for development. For production, configure RLS and auth.
 */

// ---------- CONFIG (REPLACE with your own values) ----------
const SUPABASE_URL = "https://kjmyyewjwgaxnlacszja.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqbXl5ZXdqd2dheG5sYWNzemphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNTY2OTUsImV4cCI6MjA3OTYzMjY5NX0.x1X8wpoFzERH4ZOxoDi-7OHzWmsqvbt8nGJpM2G_p8w";
// -----------------------------------------------------------

// init supabase
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime: { params: { eventsPerSecond: 10 } } });

// Determine room id: supports /room/123 or ?room=123 or last path segment
function getRoomId() {
  const q = new URLSearchParams(location.search).get('room');
  if (q) return q;
  const parts = location.pathname.split('/').filter(Boolean);
  // if path like /room/123 -> find segment after 'room'
  const idx = parts.indexOf('room');
  if (idx !== -1 && parts.length > idx+1) return parts[idx+1];
  // fallback to last segment or 'public'
  return parts[parts.length-1] || 'public';
}

const roomId = getRoomId();
document.getElementById('roomHint').textContent = 'Room: ' + roomId;

// DOM
const thread = document.getElementById('thread');
const input = document.getElementById('msg');
const sendBtn = document.getElementById('send');
const nameInput = document.getElementById('name');

// ephemeral client id (keeps shirt-term identity on device)
let clientId = localStorage.getItem('flarefix_client');
if (!clientId) { clientId = 'u-' + Math.random().toString(36).slice(2,9); localStorage.setItem('flarefix_client', clientId); }

function escapeHtml(s){ return (s||'').replace(/[&<>"]+/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c)); }

function renderMessage(m){
  const mine = (m.sender_id === clientId);
  const el = document.createElement('div');
  el.className = 'flex items-start gap-3 ' + (mine ? 'justify-end' : 'justify-start');
  const bubble = document.createElement('div');
  bubble.className = (mine ? 'bg-black text-white' : 'bg-white text-gray-800') + ' max-w-[80%] rounded-2xl px-3 py-2 shadow border';
  const who = escapeHtml(m.sender_name || (m.sender || 'Anon'));
  bubble.innerHTML = `<div class="text-xs text-gray-500 mb-1">${mine ? 'You' : who}</div><div class="text-sm">${escapeHtml(m.text)}</div>`;
  el.appendChild(bubble);
  thread.appendChild(el);
  thread.scrollTop = thread.scrollHeight;
}

// load history
async function loadHistory(){
  try{
    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .eq('room', roomId)
      .order('created_at', { ascending: true })
      .limit(200);
    if (error) { console.error('history error', error); return; }
    thread.innerHTML = '';
    data.forEach(renderMessage);
  } catch(e){ console.error(e); }
}

// realtime subscription (INSERT only)
function subscribe(){
  supabase.channel('public:messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `room=eq.${roomId}` }, payload => {
      renderMessage(payload.new);
    })
    .subscribe()
    .then(() => console.log('subscribed to room', roomId))
    .catch(e=>console.error('subscribe error', e));
}

// send
async function send(){
  const text = input.value.trim();
  if (!text) return;
  const sender_name = nameInput.value.trim() || null;
  input.value = '';

  // optimistic UI
  renderMessage({ sender_id: clientId, sender_name, text });

  const { error } = await supabase.from('messages').insert([{ room: roomId, sender: sender_name || clientId, sender_id: clientId, text }]);
  if (error) console.error('insert error', error);
}

sendBtn.addEventListener('click', send);
input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

// init
loadHistory(); subscribe();

</script>
</body>
</html>
