<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flarefix ‚Äî Secret Room</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    html,body {height:100%}
    #thread { scroll-behavior: smooth; }
  </style>
</head>

<body class="min-h-screen bg-gray-50 text-gray-900 flex flex-col">

  <!-- Header -->
  <header class="px-4 py-3 border-b bg-white sticky top-0 z-10 flex items-center gap-3">
    <button onclick="window.location.href='home.html'" class="text-sm px-3 py-1 rounded bg-gray-200">‚Üê Back</button>
    <h1 class="text-lg font-semibold">Secret Room</h1>
    <div id="roomHint" class="ml-4 text-sm text-gray-600"></div>
  </header>

  <!-- Messages -->
  <main class="flex-1 overflow-y-auto px-3 py-4">
    <div id="thread" class="max-w-3xl mx-auto space-y-3"></div>
  </main>

  <!-- Input -->
  <footer class="p-3 bg-white border-t">
    <div class="max-w-3xl mx-auto flex gap-2 items-end">
      <input id="name" placeholder="Your name (optional)" class="w-40 border rounded-xl px-3 py-2 outline-none" />
      <textarea id="msg" rows="1" placeholder="Type a private message..." class="flex-1 border rounded-xl px-3 py-2 resize-none outline-none"></textarea>
      <button id="send" class="px-4 py-2 bg-black text-white rounded-xl">Send</button>
    </div>
  </footer>


<script>
/* ---------------- Supabase Config ---------------- */
const SUPABASE_URL = "https://kjmyyewjwgaxnlacszja.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqbXl5ZXdqd2dheG5sYWNzemphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNTY2OTUsImV4cCI6MjA3OTYzMjY5NX0.x1X8wpoFzERH4ZOxoDi-7OHzWmsqvbt8nGJpM2G_p8w";
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------------- Room ID ---------------- */
function getRoomId(){
  const q = new URLSearchParams(location.search).get('room');
  if (q) return q;
  return "public";
}
const roomId = getRoomId();
document.getElementById("roomHint").textContent = "Room: " + roomId;

/* ---------------- DOM ---------------- */
const thread = document.getElementById("thread");
const input = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const nameInput = document.getElementById("name");

/* ---------------- Helper ---------------- */
function escapeHtml(s){
  return (s||"").replace(/[&<>"]/g, c => ({
    "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;"
  }[c]));
}

function renderMessage(m){
  const mine = (m.sender === localStorage.getItem("flarefix_client"));
  const div = document.createElement("div");

  div.className = "flex items-start gap-3 " + (mine ? "justify-end" : "");

  div.innerHTML = `
    <div class="max-w-[80%] rounded-2xl px-3 py-2 shadow border 
      ${mine ? "bg-black text-white" : "bg-white"}">
      <div class="text-xs text-gray-500 mb-1">${mine ? "You" : escapeHtml(m.sender)}</div>
      <div class="text-sm">${escapeHtml(m.text)}</div>
    </div>
  `;

  thread.appendChild(div);
  thread.scrollTop = thread.scrollHeight;
}

/* ---------------- Load Existing Messages ---------------- */
async function loadHistory(){
  const { data, error } = await supabase
    .from("messages")
    .select("*")
    .eq("room", roomId)
    .order("created_at", { ascending: true });

  if (error) return console.error(error);

  thread.innerHTML = "";
  data.forEach(renderMessage);
}

/* ---------------- Realtime Listener ---------------- */
supabase.channel("messages:room")
  .on("postgres_changes", {
    event: "INSERT",
    schema: "public",
    table: "messages",
    filter: `room=eq.${roomId}`
  }, payload => renderMessage(payload.new))
  .subscribe();

/* ---------------- Send Message ---------------- */
async function send(){
  const text = input.value.trim();
  if (!text) return;

  const sender = nameInput.value.trim() || localStorage.getItem("flarefix_client");

  input.value = "";

  renderMessage({ sender, text });

  await supabase.from("messages")
    .insert([{ room: roomId, sender, text }]);
}

sendBtn.addEventListener("click", send);

input.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

/* ---------------- INIT ---------------- */
if (!localStorage.getItem("flarefix_client"))
  localStorage.setItem("flarefix_client", "u-" + Math.random().toString(36).slice(2,9));

loadHistory();
</script>


<!-- Drawer Button -->
<button id="drawerBtn" class="fixed top-4 left-4 z-50 bg-black text-white px-3 py-2 rounded-lg shadow">
  ‚ò∞
</button>

<!-- Drawer -->
<div id="drawer" class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl 
  transform -translate-x-full transition-transform duration-300 z-40">

  <div class="p-4 border-b">
    <h2 class="text-lg font-semibold">Flarefix Menu</h2>
  </div>

  <ul class="p-4 space-y-4 text-gray-700 text-base">
    <li><a href="home.html" class="hover:text-black">üè† New Chat</a></li>
    <li><a href="secret-chat.html" class="hover:text-black">üîí Secret Chat</a></li>
    <li><button class="w-full text-left hover:text-black">‚öôÔ∏è Settings</button></li>
    <li><button class="w-full text-left hover:text-black">‚ÑπÔ∏è About</button></li>
  </ul>

</div>

<!-- Drawer Script (MUST BE LAST) -->
<script>
const drawer = document.getElementById("drawer");
const drawerBtn = document.getElementById("drawerBtn");
let drawerOpen = false;

drawerBtn.addEventListener("click", () => {
  drawerOpen = !drawerOpen;
  drawer.style.transform = drawerOpen ? "translateX(0)" : "translateX(-100%)";
});
</script>

</body>
</html>
