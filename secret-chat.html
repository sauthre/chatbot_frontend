<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flarefix Secret Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 text-gray-900 h-screen flex flex-col">
  <header class="px-4 py-3 border-b bg-white sticky top-0 z-10 flex items-center gap-3">
    <button onclick="window.location.href='Home.html'" class="text-sm px-3 py-1 rounded bg-gray-200">‚Üê Back</button>
    <h1 class="text-lg font-semibold">Secret Room</h1>
  </header>

  <main id="messages" class="flex-1 overflow-y-auto px-3 py-3 h-[calc(100vh-140px)]">
    <div id="thread" class="max-w-3xl mx-auto space-y-4"></div>
  </main>
  <footer class="p-3 bg-white border-t">
    <div class="max-w-2xl mx-auto flex gap-2">
      <input id="msg" placeholder="Message..." class="flex-1 border rounded-xl px-3 py-2 outline-none" />
      <button onclick="sendMessage()" class="px-4 py-2 bg-black text-white rounded-xl">Send</button>
    </div>
  </footer>

<script>
// --- IMPORTANT ---
// Paste your regenerated ANON key + project URL here AFTER we configure security.
const SUPABASE_URL = "https://kjmyyewjwgaxnlacszja.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqbXl5ZXdqd2dheG5sYWNzemphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNTY2OTUsImV4cCI6MjA3OTYzMjY5NX0.x1X8wpoFzERH4ZOxoDi-7OHzWmsqvbt8nGJpM2G_p8w";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const roomId = new URLSearchParams(window.location.search).get('room') || "public";
const chatBox = document.getElementById("chat");

async function loadMessages() {
  const { data } = await supabase.from('messages').select().eq('room', roomId).order('id');
  chatBox.innerHTML = "";
  data.forEach(addMessage);
}

function addMessage(m) {
  const div = document.createElement("div");
  div.className = "bg-white border p-2 rounded-xl shadow-sm";
  div.innerHTML = `<strong>${m.sender}</strong>: ${m.text}`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function sendMessage() {
  const msg = document.getElementById("msg").value.trim();
  if (!msg) return;
  document.getElementById("msg").value = "";

  await supabase.from('messages').insert([
    { room: roomId, sender: "User", text: msg }
  ]);
}

supabase.channel('room:' + roomId)
  .on('postgres_changes', { event: '*', schema: 'public', table:'messages' }, payload => {
      addMessage(payload.new);
  })
  .subscribe();

loadMessages();
</script>

</body>
</html>
