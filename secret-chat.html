<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flarefix — Secret Room</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    html,body{height:100%}
    #thread{scroll-behavior:smooth}
    textarea{resize:none}
  </style>
</head>
<body class="h-full bg-gray-50 text-gray-900 flex flex-col">

  <!-- Header -->
  <header class="px-4 py-3 border-b bg-white sticky top-0 z-10 flex items-center gap-3">
    <button onclick="window.location.href='home.html'" class="text-sm px-3 py-1 rounded bg-gray-200">← Back</button>
    <h1 class="text-lg font-semibold">Secret Room</h1>
    <div id="roomHint" class="ml-4 text-sm text-gray-600"></div>
  </header>

  <!-- Messages -->
  <main id="messages" class="flex-1 overflow-y-auto px-3 py-4">
    <div id="thread" class="max-w-3xl mx-auto space-y-3"></div>
  </main>

  <!-- Input -->
  <footer class="p-3 bg-white border-t">
    <div class="max-w-3xl mx-auto flex gap-2 items-end">
      <textarea id="input" rows="1" placeholder="Message..." class="flex-1 border rounded-xl px-3 py-2 outline-none max-h-40"></textarea>
      <button id="send" class="px-4 py-2 bg-black text-white rounded-xl">Send</button>
    </div>
  </footer>

  <!-- Name modal (shown until user provides name) -->
  <div id="nameModal" class="fixed inset-0 bg-black bg-opacity-40 grid place-items-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 w-[90%] max-w-md">
      <h2 class="text-lg font-semibold mb-2">Enter your name</h2>
      <input id="nameInput" placeholder="Your display name (e.g. Raj)" class="w-full border px-3 py-2 rounded mb-3" />
      <div class="flex gap-2 justify-end">
        <button id="nameCancel" class="px-4 py-2 rounded border">Cancel</button>
        <button id="nameSubmit" class="px-4 py-2 rounded bg-black text-white">Join</button>
      </div>
      <p id="nameError" class="text-sm text-red-600 mt-2 hidden"></p>
    </div>
  </div>

<script>
/* ======== CONFIG - replace with your Supabase values ======== */
const SUPABASE_URL = "REPLACE_WITH_YOUR_SUPABASE_URL";
const SUPABASE_ANON_KEY = "REPLACE_WITH_YOUR_ANON_KEY";
/* =========================================================== */

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  realtime: { params: { eventsPerSecond: 10 } }
});

// --- Room detection (supports ?room=xyz or last path segment) ---
function getRoomId() {
  const q = new URLSearchParams(location.search).get('room');
  if (q) return q;
  const parts = location.pathname.split('/').filter(Boolean);
  // if path like /room/123 -> find segment after 'room'
  const idx = parts.indexOf('room');
  if (idx !== -1 && parts.length > idx + 1) return parts[idx + 1];
  return parts[parts.length - 1] || 'public';
}

const roomId = getRoomId();
document.getElementById('roomHint').textContent = 'Room: ' + roomId;

// DOM
const thread = document.getElementById('thread');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');

// name modal
const nameModal = document.getElementById('nameModal');
const nameInput = document.getElementById('nameInput');
const nameSubmit = document.getElementById('nameSubmit');
const nameCancel = document.getElementById('nameCancel');
const nameError = document.getElementById('nameError');

// ephemeral ids
let senderId = localStorage.getItem('flarefix_sender_id');
if (!senderId) {
  senderId = 'u-' + Math.random().toString(36).slice(2,9);
  localStorage.setItem('flarefix_sender_id', senderId);
}
let senderName = localStorage.getItem('flarefix_sender_name') || null;

/* ------------------ utility ------------------ */
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]||c)); }

function scrollToBottom() { thread.scrollTop = thread.scrollHeight; }

/* render a message bubble like homepage */
function addMessageToDOM(m, opts = {prepend:false}) {
  const mine = (m.sender_id === senderId || m.sender === senderId);
  const wrapper = document.createElement('div');
  wrapper.className = 'flex items-start gap-3 ' + (mine ? 'justify-end' : 'justify-start');
  const bubble = document.createElement('div');
  bubble.className = 'max-w-[80%] rounded-2xl px-3 py-2 shadow border ' + (mine ? 'bg-black text-white' : 'bg-white text-gray-800');
  const who = escapeHtml(m.sender_name || m.sender || m.sender_id || 'Anon');
  const when = new Date(m.created_at || Date.now()).toLocaleTimeString();
  bubble.innerHTML = `<div class="text-xs text-gray-500 mb-1">${mine ? 'You' : who} <span class="text-[10px] text-gray-400">• ${when}</span></div><div class="text-sm">${escapeHtml(m.text)}</div>`;
  wrapper.appendChild(bubble);
  if (opts.prepend) thread.insertBefore(wrapper, thread.firstChild);
  else thread.appendChild(wrapper);
  scrollToBottom();
}

/* ------------------ room check ------------------ */
async function ensureRoomExists() {
  try {
    const { data } = await supabase
      .from('rooms')
      .select('room_id')
      .eq('room_id', roomId)
      .maybeSingle();
    return !!data;
  } catch(e){ console.error(e); return false; }
}

/* ------------------ load history ------------------ */
async function loadHistory() {
  const { data, error } = await supabase
    .from('messages')
    .select('*')
    .eq('room', roomId)
    .order('created_at', { ascending: true })
    .limit(500);
  if (error) { console.error('history error', error); return; }
  thread.innerHTML = '';
  data.forEach(addMessageToDOM);
}

/* ------------------ realtime subscribe ------------------ */
function subscribeRealtime() {
  supabase.channel('public:messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `room=eq.${roomId}` }, payload => {
      // avoid duplicating optimistic message if sender is self (we can rely on server signal)
      addMessageToDOM(payload.new);
    })
    .subscribe()
    .then(() => console.log('subscribed to room', roomId))
    .catch(e => console.error('subscribe error', e));
}

/* ------------------ send message ------------------ */
async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  input.style.height = 'auto';

  // optimistic UI
  addMessageToDOM({
    room: roomId,
    sender_id: senderId,
    sender_name: senderName,
    text,
    created_at: new Date().toISOString()
  });

  // insert to supabase
  const { error } = await supabase.from('messages').insert([{
    room: roomId,
    sender_id: senderId,
    sender_name: senderName,
    text
  }]);
  if (error) {
    console.error('insert error', error);
    // optionally show an error bubble
  }
}

/* ------------------ name modal flow ------------------ */
function showNameModal() {
  nameError.classList.add('hidden');
  nameModal.classList.remove('hidden');
  nameInput.focus();
}

nameSubmit.addEventListener('click', () => {
  const v = nameInput.value.trim();
  if (!v) { nameError.textContent = "Name required"; nameError.classList.remove('hidden'); return; }
  senderName = v;
  localStorage.setItem('flarefix_sender_name', senderName);
  nameModal.classList.add('hidden');
  initChatAfterName();
});

nameCancel.addEventListener('click', () => {
  // If user cancels, redirect to join/create pages
  window.location.href = 'join-room.html';
});

/* ------------------ init flow ------------------ */
async function init() {
  // Check room exists
  const ok = await ensureRoomExists();
  if (!ok) {
    // not found -> redirect to join/create with message
    alert('Room not found. Please create or join the room first.');
    window.location.href = 'join-room.html';
    return;
  }

  // If we already have a name stored, reuse it; otherwise ask
  senderName = localStorage.getItem('flarefix_sender_name');
  if (!senderName) {
    showNameModal();
    return;
  }

  // If we have name, continue
  initChatAfterName();
}

async function initChatAfterName() {
  // load history, subscribe
  await loadHistory();
  subscribeRealtime();

  // attach input handlers (Enter key)
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  sendBtn.addEventListener('click', sendMessage);

  // auto expand
  input.addEventListener('input', () => {
    input.style.height = 'auto';
    input.style.height = input.scrollHeight + 'px';
  });

  input.focus();
}

/* -------------- run init -------------- */
init();

</script>
</body>
</html>
