<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flarefix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #messages { scroll-behavior: smooth; }

    /* Typing dots animation */
    .typing span {
      display:inline-block; width:6px; height:6px; margin:0 2px;
      border-radius:9999px; opacity:.3; animation: blink 1.2s infinite;
    }
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes blink { 0%,100%{opacity:.2} 50%{opacity:1} }

    /* Chat bubble animation */
    .chat-bubble {
      animation: fadeInUp 0.4s ease;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Input box typing animation */
    #input {
      overflow-wrap: break-word;
      word-break: break-word;
      resize: none;
    }

    /* Send button hover animation */
    #send {
      transition: all 0.3s ease;
    }
    #send:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    /* Processing fade animation */
    #processing {
      display: none;
      text-align: center;
      margin-bottom: 0.5rem;
      color: #374151;
      font-weight: 500;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%,100% { opacity: 0.4; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body class="h-full bg-gray-50 text-gray-900">
  <div class="flex flex-col h-screen">
    <!-- HEADER -->
    <header class="px-4 py-3 border-b bg-white sticky top-0 z-10 shadow-md">
      <div class="max-w-5xl mx-auto flex items-center gap-3">
        <!-- Flarefix logo -->
        <div class="w-9 h-9 rounded-2xl bg-gray-800 text-gray-100 grid place-items-center font-bold animate-bounce">
          F
        </div>
        <h1 class="text-lg font-semibold text-gray-800">Flarefix</h1>
      </div>
    </header>

    <!-- MAIN CHAT -->
    <main id="messages" class="flex-1 overflow-y-auto px-4 py-4">
      <div id="thread" class="max-w-3xl mx-auto space-y-4"></div>
    </main>

    <!-- FOOTER INPUT -->
    <footer class="px-4 pb-4">
      <div class="max-w-3xl mx-auto">
        <div id="processing">Processing your request...</div>
        <div class="rounded-2xl border bg-white shadow-md transition-all duration-300 hover:shadow-lg">
          <div class="p-3">
            <textarea id="input" rows="1" placeholder="Message Flarefix..." class="w-full outline-none max-h-40"></textarea>
          </div>
          <div class="px-3 pb-3 flex justify-end">
            <button id="send" class="px-4 py-1.5 rounded-xl bg-gray-800 hover:bg-gray-900 text-white">Send</button>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const API_URL = "https://chatbot-backend-hrvb.onrender.com/chat";

    const sessionId = crypto.randomUUID(); // ✅ fresh session every time

    const threadEl = document.getElementById('thread');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const messagesView = document.getElementById('messages');
    const processingEl = document.getElementById('processing');

    let messages = []; // ✅ start fresh, no localStorage

    function escapeHtml(s){ 
      return String(s).replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); 
    }

    function render(){
      threadEl.innerHTML = '';
      messages.forEach(m=>{
        const isUser = m.role === 'user';
        const div = document.createElement('div');
        div.className = `flex items-end gap-2 ${isUser ? 'justify-end':''}`;

        if (isUser) {
          // User message bubble
          div.innerHTML = `
            <div class="chat-bubble max-w-[75%] rounded-2xl px-3 py-2 shadow border text-sm bg-gray-800 text-white">
              ${escapeHtml(m.content)}
            </div>`;
        } else {
          // Assistant with Flarefix logo
          div.innerHTML = `
            <div class="w-7 h-7 rounded-full bg-gray-700 text-white flex items-center justify-center text-xs font-bold">F</div>
            <div class="chat-bubble max-w-[75%] rounded-2xl px-3 py-2 shadow border text-sm bg-white border-gray-200">
              ${escapeHtml(m.content)}
            </div>`;
        }
        threadEl.appendChild(div);
      });
      messagesView.scrollTop = messagesView.scrollHeight;
    }

    render();

    async function sendMessage(){
      const text = inputEl.value.trim();
      if(!text) return;
      inputEl.value = '';
      sendBtn.disabled = true;
      processingEl.style.display = 'block';

      messages.push({role:'user', content:text});
      render();

      try{
        const payload = { message: text, user_id: sessionId };
        const res = await fetch(API_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        if(!res.ok){
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        messages.push({role:'assistant', content: data.reply || 'No response'});
      }catch(e){
        messages.push({role:'assistant', content:'Error: '+e.message});
      }

      processingEl.style.display = 'none';
      render();
      sendBtn.disabled = false;
      inputEl.focus();
    }

    inputEl.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });
    sendBtn.addEventListener('click', sendMessage);

    // Auto-expand textarea
    inputEl.addEventListener("input", () => {
      inputEl.style.height = "auto";
      inputEl.style.height = inputEl.scrollHeight + "px";
    });
  </script>
</body>
</html>